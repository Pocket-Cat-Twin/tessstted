name: ğŸ”§ Lolita Fashion - CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # ğŸ” NAMESPACE VALIDATION (Critical)
  namespace-check:
    name: ğŸ” Namespace Consistency Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check for @yuyu namespace usage
        run: |
          if grep -r "@yuyu/" apps/ packages/ --include="*.ts" --include="*.js" --include="*.svelte" 2>/dev/null; then
            echo "âŒ Found @yuyu/ imports! Use @lolita-fashion/ instead"
            echo "Files with issues:"
            grep -r "@yuyu/" apps/ packages/ --include="*.ts" --include="*.js" --include="*.svelte" -l 2>/dev/null || true
            exit 1
          else
            echo "âœ… All imports use correct @lolita-fashion/ namespace"
          fi

  # ğŸ“¦ BUILD VALIDATION
  build-validation:
    name: ğŸ“¦ Build & Type Check Validation
    runs-on: ubuntu-latest
    needs: namespace-check
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
          
      - name: Install dependencies
        run: bun install --frozen-lockfile
        
      - name: Build shared packages
        run: |
          cd packages/shared && bun run build
          cd ../db && bun run build
          
      - name: ğŸ”§ TypeScript Type Checking
        run: bun run type-check
        
      - name: ğŸ“± Build Web App
        run: cd apps/web && bun run build
        
      - name: ğŸš€ Build API
        run: cd apps/api && bun run build
        
      - name: âœ… Verify Build Artifacts
        run: |
          echo "ğŸ” Checking build outputs..."
          ls -la apps/web/.svelte-kit/output/ || echo "âš ï¸ Web build output not found"
          ls -la apps/api/dist/ || echo "âš ï¸ API build output not found"

  # ğŸ§ª CODE QUALITY CHECKS  
  quality-checks:
    name: ğŸ§ª Code Quality & Security
    runs-on: ubuntu-latest
    needs: namespace-check
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
          
      - name: Install dependencies
        run: bun install --frozen-lockfile
        
      - name: ğŸ¨ Code Formatting Check
        run: |
          bun run format
          if [[ -n $(git status --porcelain) ]]; then
            echo "âŒ Code formatting issues found. Run 'bun run format' locally."
            git diff
            exit 1
          else
            echo "âœ… Code formatting is correct"
          fi
          
      - name: ğŸ”’ Security Audit
        run: bun audit --audit-level moderate || echo "âš ï¸ Security audit completed with warnings"

  # ğŸ¯ DEPLOYMENT READINESS
  deployment-check:
    name: ğŸ¯ Deployment Readiness
    runs-on: ubuntu-latest
    needs: [build-validation, quality-checks]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
          
      - name: Install dependencies
        run: bun install --frozen-lockfile
        
      - name: Build shared packages
        run: |
          cd packages/shared && bun run build
          cd ../db && bun run build
          
      - name: ğŸ—ï¸ Production Build Test
        env:
          NODE_ENV: production
        run: |
          cd apps/web && bun run build
          cd ../api && bun run build
          echo "âœ… Production build successful"
          
      - name: ğŸ“Š Bundle Size Analysis
        run: |
          echo "ğŸ“Š Web App Bundle Analysis:"
          du -sh apps/web/.svelte-kit/output/client/_app/immutable/ || echo "No client bundles found"
          echo ""
          echo "ğŸ“Š API Bundle Analysis:" 
          du -sh apps/api/dist/ || echo "No API build found"

  # âœ… SUCCESS SUMMARY
  success:
    name: âœ… All Checks Passed
    runs-on: ubuntu-latest
    needs: [namespace-check, build-validation, quality-checks]
    if: success()
    
    steps:
      - name: ğŸ‰ Success Notification
        run: |
          echo "ğŸ‰ All CI checks passed successfully!"
          echo "âœ… Namespace consistency verified"
          echo "âœ… Builds completed without errors"  
          echo "âœ… Type checking passed"
          echo "âœ… Code quality validated"
          echo ""
          echo "ğŸš€ Ready for deployment!"