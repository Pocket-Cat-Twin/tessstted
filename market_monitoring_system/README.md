# Market Monitoring System

Система автоматического мониторинга товаров и продавцов через скриншоты с последующим распознаванием текста и отслеживанием изменений.

## Описание

Этот проект представляет собой комплексную систему мониторинга торговых площадок, которая:

- Автоматически захватывает скриншоты по нажатию горячих клавиш
- Обрабатывает и объединяет изображения в вертикальные столбцы
- Распознает текст с помощью Yandex OCR API
- Извлекает структурированную информацию о товарах и продавцах
- Отслеживает изменения цен, количества и появление новых товаров
- Управляет жизненным циклом статусов мониторинга
- Автоматически выполняет задачи по расписанию

## Особенности

### Основная функциональность

- **Глобальные горячие клавиши**: Захват скриншотов по нажатию F1, F2, и т.д.
- **Автоматическая обработка**: Объединение изображений и OCR распознавание
- **Интеллектуальный парсинг**: Извлечение данных с помощью регулярных выражений
- **Отслеживание изменений**: Автоматическое сравнение с предыдущими данными
- **Статусный мониторинг**: Управление жизненным циклом NEW → CHECKED → UNCHECKED
- **Планировщик задач**: Автоматическое выполнение по расписанию

### Технические особенности

- **Профессиональное логирование**: JSON и текстовые логи с ротацией
- **Обработка ошибок**: Retry логика для API запросов и обработка сбоев
- **База данных**: SQLite с индексами и оптимизацией
- **Конфигурация**: JSON конфигурация с валидацией
- **Модульная архитектура**: Четкое разделение ответственности
- **Context managers**: Proper resource management
- **Threading**: Thread-safe операции

## Архитектура системы

```
market_monitoring_system/
├── src/
│   ├── config/           # Управление конфигурацией
│   ├── core/            # Основные модули
│   │   ├── database_manager.py
│   │   ├── screenshot_capture.py
│   │   ├── image_processor.py
│   │   ├── ocr_client.py
│   │   ├── text_parser.py
│   │   └── monitoring_engine.py
│   ├── utils/           # Вспомогательные утилиты
│   │   ├── logger.py
│   │   ├── scheduler.py
│   │   └── file_utils.py
│   └── main.py          # Главная точка входа
├── data/                # Временные данные и логи
├── database/            # База данных SQLite
├── config.json          # Конфигурация системы
└── requirements.txt     # Python зависимости
```

## Установка

### Требования

- Python 3.9+
- Операционная система: Windows, Linux, macOS
- Yandex Cloud OCR API ключ

### Установка зависимостей

```bash
cd market_monitoring_system
pip install -r requirements.txt
```

### Конфигурация

1. Скопируйте и отредактируйте `config.json`:

```json
{
    "hotkeys": {
        "F1": {
            "area": [100, 100, 800, 600],
            "folder": "F1",
            "merge_interval": 30,
            "enabled": true,
            "description": "Главная страница товаров"
        }
    },
    "yandex_ocr": {
        "api_key": "your_yandex_api_key_here",
        "api_url": "https://ocr.api.cloud.yandex.net/ocr/v1/recognizeText"
    }
}
```

2. Получите API ключ Yandex Cloud OCR:
   - Зарегистрируйтесь в [Yandex Cloud](https://cloud.yandex.ru/)
   - Создайте сервисный аккаунт с ролью `ai.vision.user`
   - Получите API ключ и добавьте его в конфигурацию

## Использование

### Запуск системы

```bash
# Основной запуск
python src/main.py

# С указанием конфигурации
python src/main.py --config custom_config.json

# Тест инициализации
python src/main.py --test-only

# Проверка статуса
python src/main.py --status
```

### Рабочий процесс

1. **Настройка горячих клавиш**: Определите области экрана для захвата
2. **Захват скриншотов**: Нажимайте F1, F2 и т.д. для создания скриншотов
3. **Автоматическая обработка**: Система объединит изображения и распознает текст
4. **Мониторинг изменений**: Автоматическое сравнение и уведомления об изменениях
5. **Просмотр данных**: Анализ собранной информации в базе данных

### Горячие клавиши

- **F1**: Главная страница товаров (по умолчанию каждые 30 сек)
- **F2**: Страница продавцов (по умолчанию каждые 60 сек)
- **F3, F4**: Дополнительные страницы (настраивается)

## База данных

### Схема таблиц

#### `items` - История товаров
```sql
CREATE TABLE items (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    seller_name TEXT NOT NULL,
    item_name TEXT NOT NULL,
    price REAL,
    quantity INTEGER,
    item_id TEXT,
    hotkey TEXT NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

#### `sellers_current` - Текущее состояние продавцов
```sql
CREATE TABLE sellers_current (
    seller_name TEXT NOT NULL,
    item_name TEXT NOT NULL,
    quantity INTEGER,
    last_updated DATETIME,
    status TEXT CHECK(status IN ('NEW', 'CHECKED', 'UNCHECKED')),
    UNIQUE(seller_name, item_name)
);
```

#### `changes_log` - Лог изменений
```sql
CREATE TABLE changes_log (
    seller_name TEXT NOT NULL,
    item_name TEXT NOT NULL,
    change_type TEXT CHECK(change_type IN (
        'PRICE_INCREASE', 'PRICE_DECREASE', 
        'QUANTITY_INCREASE', 'QUANTITY_DECREASE',
        'NEW_ITEM', 'ITEM_REMOVED'
    )),
    old_value TEXT,
    new_value TEXT,
    detected_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### Жизненный цикл статусов

```
NEW → обнаружена новая связка (продавец + товар)
  ↓
CHECKED → информация найдена в таблице товаров
  ↓ (через 10 минут)
UNCHECKED → ждем повторного появления данных
  ↓
Цикл повторяется или запись удаляется
```

## Логирование

### Структура логов

- **market_monitoring.log**: Основные логи в текстовом формате
- **market_monitoring.json.log**: Структурированные JSON логи
- **Автоматическая ротация**: По размеру файла (100MB) с 5 backup файлами

### Уровни логирования

- **DEBUG**: Детальная информация для отладки
- **INFO**: Основные события системы
- **WARNING**: Предупреждения о проблемах
- **ERROR**: Ошибки, требующие внимания
- **CRITICAL**: Критические ошибки системы

## Мониторинг и обслуживание

### Автоматические задачи

- **Обработка скриншотов**: По настроенным интервалам для каждой горячей клавиши
- **Проверка статусов**: Каждые 10 минут
- **Очистка данных**: Ежедневно в 2:00
- **Оптимизация БД**: Еженедельно в воскресенье в 3:00

### Мониторинг здоровья системы

Система выполняет автоматические проверки:

- Подключение к базе данных
- Доступность OCR API
- Права доступа к файловой системе
- Статистика работы компонентов

## API и интеграции

### Yandex Cloud OCR

Система использует [Yandex Cloud Vision OCR API](https://cloud.yandex.ru/docs/vision/ocr/) для распознавания текста.

**Особенности интеграции:**
- Retry логика с экспоненциальной задержкой
- Rate limiting обработка
- Автоматическая оптимизация изображений для OCR
- Поддержка множественных языков (русский, английский)

### Расширения

Система спроектирована для легкого расширения:

- **Новые парсинг паттерны**: Добавление regex паттернов для новых форматов
- **Дополнительные OCR провайдеры**: Интеграция других OCR сервисов
- **Экспорт данных**: JSON, CSV, Excel форматы
- **Уведомления**: Email, Telegram, Slack интеграции

## Устранение неисправностей

### Частые проблемы

#### OCR API ошибки
```
Ошибка: "Unauthorized - check API key"
Решение: Проверьте правильность API ключа в config.json
```

#### Проблемы с горячими клавишами  
```
Ошибка: "Failed to register hotkey F1"
Решение: Закройте другие приложения, использующие эту клавишу
```

#### Ошибки базы данных
```
Ошибка: "Database is locked"
Решение: Проверьте права доступа к папке database/
```

### Отладка

1. **Включите DEBUG логи**:
   ```json
   {
     "logging": {
       "level": "DEBUG"
     }
   }
   ```

2. **Проверьте статус системы**:
   ```bash
   python src/main.py --status
   ```

3. **Тестовый запуск**:
   ```bash
   python src/main.py --test-only
   ```

### Производительность

#### Рекомендации по оптимизации

- **Размер изображений**: Не превышайте 20MB для OCR
- **Интервалы обработки**: Увеличьте интервалы для снижения нагрузки
- **Очистка данных**: Настройте автоматическую очистку старых записей
- **Индексы БД**: Система автоматически создает необходимые индексы

#### Мониторинг ресурсов

```bash
# Размер базы данных
du -h database/

# Размер логов
du -h data/logs/

# Размер временных файлов
du -h data/temp/
```

## Безопасность

### Рекомендации

- **API ключи**: Храните в переменных окружения или защищенных файлах
- **Права доступа**: Ограничьте доступ к папке с базой данных
- **Логи**: Не включайте чувствительную информацию в логи
- **Резервные копии**: Регулярно создавайте резервные копии базы данных

### Конфиденциальность

- Скриншоты удаляются сразу после обработки
- OCR JSON ответы не сохраняются
- База данных содержит только извлеченные структурированные данные

## Лицензия

Этот проект разработан для образовательных и исследовательских целей. 

## Поддержка

Для вопросов и предложений создавайте issues в репозитории проекта.

---

*Система разработана с использованием современных практик Python разработки и enterprise-grade архитектурных решений.*